<style>
	.keyboard {
		display: flex;
		align-items: center;
		justify-content: center;
		width: 100%;
		height: 100%;
	}
	.scale {
		display: grid;
		grid-template-columns: repeat(3, 1fr);
		grid-template-rows: repeat(4, 1fr);
		gap: 0.3em;
		padding: 0.2em;
		font-size: 1.2em;
		height: 35vh;
		width: 100%;
	}
	.key {
		display: flex;
		flex-direction: column;
		border: medium solid #444;
		border-radius: 3px;
		overflow: hidden;
		cursor: pointer;
		padding-top: 0.1em;
		font-size: 1.2em;
		color: #aaa;
	}
	.key::before {
		content: attr(data-key);
		text-align: center;
		height: 1.2em;
	}
	.key[data-key='tab'] {
		grid-column: 1 / -1;
	}
	.key[data-key='tab'].hidden {
		display: none;
	}
	.scale:has(.key[data-key='tab'].hidden) {
		grid-template-rows: repeat(3, 1fr);
	}
	.key[data-key='q'] {
		border-color: red;
	}
	.key[data-key='e'] {
		border-color: blue;
	}
	.key.pressed {
		border-color: white;
	}
	.content {
		flex: 1;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 1.25em;
		font-weight: bold;
		padding: 0.1em;
		overflow: hidden;
		color: #fff;
	}
	.key[data-key='q'] .content,
	.key[data-key='e'] .content {
		font-size: 0.85em;
	}
	.content svg {
		max-width: 95%;
		max-height: 95%;
	}
</style>

<div class="keyboard"><div class="scale"></div></div>

<script>
	(function (u) {
		if (!u || u.kb) return;

		const KEYS = ['tab', 1, 2, 3, 'q', 'w', 'e', 'a', 's', 'd'];
		const scale = document.querySelector('.scale');
		const els = {};

		scale.innerHTML = KEYS.map(
			(k) =>
				`<div class="key${k === 'tab' ? ' hidden' : ''}" data-key="${k}"><div class="content"></div></div>`,
		).join('');

		scale.querySelectorAll('.key').forEach((key) => {
			const k = key.dataset.key;
			els[k] = { key, content: key.firstElementChild };
			key.onpointerdown = () => u.handleKey(k, true);
			key.onpointerup = key.onpointerleave = () => u.handleKey(k, false);
		});

		u.kb = {
			update(k) {
				const bind = u.keybinds.get(k);
				els[k]?.key.classList.toggle('pressed', !!bind?.pressed);
				this.render();
			},
			render() {
				const {
					layouts,
					layout: [li, vi],
					keybinds,
					focused,
				} = u;
				if (!layouts?.length) return;

				const current = layouts[li];
				els.tab.key.classList.toggle('hidden', !li);
				if (li)
					els.tab.content.innerHTML =
						current.focus?.[vi * current.visible + focused] ?? '';

				[1, 2, 3].forEach((n) => {
					const l = layouts[n - 1];
					const idx =
						n === 1 || li !== n - 1
							? 0
							: (vi + 1) % l.variants.length;
					els[n].content.innerHTML = l?.variants[idx].svg ?? '';
				});

				['q', 'w', 'e', 'a', 's', 'd'].forEach(
					(k) =>
						(els[k].content.textContent =
							keybinds.get(k)?.desc ?? ''),
				);
			},
		};

		u.kb.render();
	})(pathless);
</script>
