<style>
	.keyboard {
		display: flex;
		align-items: center;
		justify-content: center;
		width: 40%;
		height: 100%;
		padding: 0.1em;
	}
	.scale {
		display: grid;
		grid-template-columns: repeat(3, 1fr);
		grid-auto-rows: 1fr;
		gap: 0.3em;
		padding: 0.2em 2em 0.5em;
		box-sizing: border-box;
		font-size: 1.2em;
		width: 100%;
		height: 100%;
	}
	.key {
		display: flex;
		flex-direction: column;
		border: medium solid #444;
		border-radius: 3px;
		overflow: hidden;
		cursor: pointer;
		user-select: none;
		padding-top: 0.1em;
		font-size: 1.2em;
		color: #aaa;
		min-height: 0;
	}
	.key::before {
		content: attr(data-key);
		text-align: center;
		height: 1.2em;
		flex-shrink: 0;
	}
	.key[data-key='tab'] {
		grid-column: 1 / -1;
	}
	.key[data-key='tab'].hidden {
		display: none;
	}
	.key[data-key='q'] {
		border-color: red;
	}
	.key[data-key='e'] {
		border-color: blue;
	}
	.key.pressed {
		border-color: white;
	}
	.key .content {
		flex: 1;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 1.25em;
		font-weight: bold;
		padding: 0.1em;
		overflow: hidden;
		color: #fff;
		min-height: 0;
	}
	.key[data-key='q'] .content,
	.key[data-key='e'] .content {
		font-size: 0.85em;
	}
	.key .content svg {
		max-width: 100%;
		max-height: 100%;
	}
</style>

<div class="keyboard">
	<div class="scale"></div>
</div>

<script>
	if (!window.Keyboard) {
		class Keyboard {
			static KEYS = ['tab', '1', '2', '3', 'q', 'w', 'e', 'a', 's', 'd'];

			constructor(u) {
				this.u = u;
				this.els = {};
				this.visible = false;
				this.keyboard = document.querySelector('.keyboard');
				this.scale = document.querySelector('.scale');
				this.build();
				this.render();
			}

			get el() {
				return this.keyboard;
			}

			build() {
				const frag = document.createDocumentFragment();
				for (const k of Keyboard.KEYS) {
					const el = document.createElement('div');
					el.className = 'key';
					el.dataset.key = k;
					el.innerHTML = '<div class="content"></div>';
					el.onclick = () => this.u.keybinds.get(k)?.fx?.();
					this.els[k] = { key: el, content: el.firstChild };
					frag.appendChild(el);
				}
				this.scale.appendChild(frag);
			}

			render() {
				const { layouts, layout, keybinds, focused } = this.u;
				if (!layouts) return;

				const showTab = layout[0] === 1 || layout[0] === 2;
				this.els['tab'].key.classList.toggle('hidden', !showTab);
				this.scale.style.gridTemplateRows = showTab
					? 'repeat(4, 1fr)'
					: 'repeat(3, 1fr)';

				for (const k of Keyboard.KEYS) {
					const { content } = this.els[k];
					const n = parseInt(k);

					if (k === 'tab') {
						if (!showTab) continue;
						const l = layouts[layout[0]];
						const idx =
							layout[0] === 0
								? 0
								: layout[1] * l.visible + focused;
						content.innerHTML = l?.focus?.[idx] ?? '';
					} else if (n) {
						const l = layouts[n - 1];
						if (!l) {
							content.innerHTML = '';
							continue;
						}
						const idx =
							n === 1 || layout[0] !== n - 1
								? 0
								: (layout[1] + 1) % l.variants.length;
						content.innerHTML = l.variants[idx].svg;
					} else {
						content.textContent = keybinds.get(k)?.desc ?? '';
					}
				}
			}

			press(k) {
				this.els[k]?.key.classList.add('pressed');
			}
			release(k) {
				this.els[k]?.key.classList.remove('pressed');
			}
		}
		window.Keyboard = Keyboard;
	}
</script>
